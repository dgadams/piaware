# Author:   D. G. Adams
#
# Date:     2024-Sep-18
#
# This is the smallest piaware image I can get. Done by muntzing the libraries
# from the build image.
# Debian seems to be required for proper full operation

FROM debian:bookworm-slim  AS  build

# Build Dump1090
RUN <<EOF
    apt-get update
    apt-get -yq install \
      build-essential \
      debhelper \
      fakeroot \
      git \
      libncurses-dev \
      librtlsdr-dev \
      pkg-config
    git clone https://github.com/flightaware/dump1090.git /dump1090
    cd /dump1090
    dpkg-buildpackage -b --no-sign --build-profiles=custom,rtlsdr
EOF

# Build Piaware
RUN <<EOF
    apt-get -yq install devscripts tcl8.6-dev autoconf \
        python3-dev python3-venv python3-setuptools libz-dev openssl \
        libboost-system-dev libboost-program-options-dev libboost-regex-dev \
        libboost-filesystem-dev patchelf libncurses6 librtlsdr0 net-tools \
        wget python3-pip python3-build python3-wheel
    git clone "https://github.com/flightaware/piaware_builder.git"
    cd /piaware_builder
    ./sensible-build.sh bookworm
    cd ./package-bookworm
    dpkg-buildpackage -b --no-sign
EOF

# Set up files
WORKDIR /bld-files
COPY files/* .
RUN <<EOF
    mv /piaware_builder/piaware_9.0.1_amd64.deb ./piaware.deb
    mv /dump1090/debian/dump1090-fa/usr/bin/dump1090-fa ./dump1090-fa
    mv /dump1090/public_html/ .
EOF
#####################################################################

FROM debian:bookworm-slim AS install

WORKDIR /dump1090
COPY --from=build /bld-files  ./

RUN <<ENDRUN
    apt-get -yq update
    apt-get -yq install nginx ./piaware.deb 
    apt-get -yq install libusb-1.0-0 librtlsdr0 libncurses6
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    adduser --no-create-home --disabled-login --disabled-password piaware

#   move files
    mv dump1090-fa /usr/bin
    rm -rf piaware.deb

#   remove unneeded files - do a little muntzing.
#   This is deceptive. Only files added in this RUN get removed from the image.
    rm -rf /lib/x86_64-linux-gnu/libsystemd*
    rm -rf /lib/x86_64-linux-gnu/libsmartcols*
    rm -rf /lib/x86_64-linux-gnu/libreadline*
    rm -rf /lib/x86_64-linux-gnu/libp11-kit*
    rm -rf /lib/x86_64-linux-gnu/libkrb5*
    rm -rf /lib/x86_64-linux-gnu/libicu*
    rm -rf /lib/x86_64-linux-gnu/libgnutls*
    rm -rf /lib/x86_64-linux-gnu/libdb*
    rm -rf /lib/x86_64-linux-gnu/libboost*
    rm -rf /lib/x86_64-linux-gnu/libnettle*
    rm -rf /lib/x86_64-linux-gnu/libmvec*
    rm -rf /lib/x86_64-linux-gnu/libndn2*
    rm -rf /lib/x86_64-linux-gnu/libcuuc*
    rm -rf /lib/x86_64-linux-gnu/libgmp*
    rm -rf /lib/x86_64-linux-gnu/libbpf*
    rm -rf /lib/x86_64-linux-gnu/libapt*
    rm -rf /lib/x86_64-linux-gnu/libxxhash*
    rm -rf /lib/x86_64-linux-gnu/libtirpc*
    rm -rf /lib/x86_64-linux-gnu/libnsl*
    rm -rf /lib/x86_64-linux-gnu/libhogweed*
    rm -rf /lib/x86_64-linux-gnu/libgssapi*
    rm -rf /lib/x86_64-linux-gnu/liblzma5*
#    rm -rf /lib/x86_64-linux-gnu/kkk

    rm -rf /usr/share/doc
    rm -rf /usr/share/zoneinfo

#   common setup and change ownership of directories
    mkdir /run/dump1090
    mkdir /var/run/piaware
    mkdir /var/cache/piaware
    touch /etc/piaware.conf
    touch /dump1090/public_html/upintheair.json
    chown -R piaware /run/dump1090
    chown -R piaware /run/piaware
    chown -R piaware /var/cache/piaware
    chown -R piaware /var/log/nginx
    chown -R piaware /var/lib/nginx
    chown piaware /etc/piaware.conf
    chown piaware /dump1090/public_html
    rm -rf /etc/nginx
ENDRUN

EXPOSE 8080
USER piaware
CMD ["/dump1090/piaware.sh"]
